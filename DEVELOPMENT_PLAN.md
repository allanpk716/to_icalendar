# Snipaste截图识别集成开发计划

## 项目概述

本文档记录了为 `to_icalendar` 项目集成 Snipaste 截图识别功能的详细开发计划。该功能将支持从剪贴板读取截图内容，通过 Dify API 进行 OCR 和语义理解，生成标准化的提醒事项 JSON 文件。

## 技术方案

### 功能流程
```
Snipaste截图 → 剪贴板读取 → Dify API处理 → 语义解析 → JSON草稿生成 → 手动上传至Todo
```

### 新增模块架构
```
internal/
├── clipboard/          # 剪贴板读取模块
├── dify/              # Dify API集成模块
├── processors/        # 内容处理器
└── models/           # 扩展数据结构
```

## 开发任务清单

### 阶段一：基础架构搭建

#### 1.1 项目依赖管理
- [x] **添加剪贴板处理依赖**
  - 任务：在 go.mod 中添加 `github.com/atotto/clipboard` 库
  - 负责模块：依赖管理
  - 预计时间：30分钟
  - 完成时间：2025-11-05

- [x] **添加图片处理依赖**
  - 任务：在 go.mod 中添加 `github.com/disintegration/imaging` 库
  - 负责模块：图片处理
  - 预计时间：30分钟
  - 完成时间：2025-11-05

- [x] **添加HTTP客户端增强依赖**
  - 任务：在 go.mod 中添加 `github.com/go-resty/resty` 库
  - 负责模块：API调用
  - 预计时间：30分钟
  - 完成时间：2025-11-05

#### 1.2 配置结构扩展
- [x] **扩展ServerConfig结构**
  - 任务：在 `internal/models/config.go` 中添加 Dify API 配置字段
  - 文件：internal/models/config.go
  - 负责模块：配置管理
  - 预计时间：1小时
  - 完成时间：2025-11-05

- [x] **创建Dify配置结构**
  - 任务：新建 `internal/models/dify_config.go` 定义 Dify API 相关数据结构
  - 文件：internal/models/dify_config.go
  - 负责模块：数据模型
  - 预计时间：1小时
  - 完成时间：2025-11-05

- [x] **更新配置文件模板**
  - 任务：在配置文件模板中添加 Dify 配置段示例
  - 文件：config/server.yaml (或配置模板)
  - 负责模块：配置管理
  - 预计时间：30分钟
  - 完成时间：2025-11-05

#### 1.3 剪贴板模块开发
- [x] **创建剪贴板读取接口**
  - 任务：新建 `internal/clipboard/reader.go` 定义剪贴板操作接口
  - 文件：internal/clipboard/reader.go
  - 负责模块：剪贴板处理
  - 预计时间：1小时
  - 完成时间：2025-11-05

- [x] **实现跨平台剪贴板读取**
  - 任务：新建 `internal/clipboard/clipboard.go` 实现具体的剪贴板读取功能
  - 文件：internal/clipboard/clipboard.go
  - 负责模块：剪贴板处理
  - 预计时间：2小时
  - 完成时间：2025-11-05

#### 1.4 Dify API客户端开发
- [x] **创建Dify API客户端结构**
  - 任务：新建 `internal/dify/client.go` 实现Dify API基础客户端
  - 文件：internal/dify/client.go
  - 负责模块：Dify集成
  - 预计时间：2小时
  - 完成时间：2025-11-05

- [x] **定义Dify API数据结构**
  - 任务：新建 `internal/dify/types.go` 定义API请求和响应结构
  - 文件：internal/dify/types.go
  - 负责模块：Dify集成
  - 预计时间：1小时
  - 完成时间：2025-11-05

### 阶段二：核心功能实现

#### 2.1 OCR识别功能
- [x] **实现图片OCR识别**
  - 任务：在 `internal/dify/processor.go` 中实现图片OCR处理功能
  - 文件：internal/dify/processor.go
  - 负责模块：Dify集成
  - 预计时间：3小时
  - 完成时间：2025-11-05

- [x] **实现文字语义理解**
  - 任务：在 `internal/dify/processor.go` 中实现文字内容的语义理解
  - 文件：internal/dify/processor.go
  - 负责模块：Dify集成
  - 预计时间：2小时
  - 完成时间：2025-11-05

#### 2.2 内容处理模块
- [x] **创建图片内容处理器**
  - 任务：新建 `internal/processors/image_processor.go` 处理截图内容
  - 文件：internal/processors/image_processor.go
  - 负责模块：内容处理
  - 预计时间：3小时
  - 完成时间：2025-11-05

- [x] **创建文字内容处理器**
  - 任务：新建 `internal/processors/text_processor.go` 处理文字内容
  - 文件：internal/processors/text_processor.go
  - 负责模块：内容处理
  - 预计时间：2小时
  - 完成时间：2025-11-05

- [x] **实现任务信息解析器**
  - 任务：新建 `internal/processors/parser.go` 从Dify结果中提取任务信息
  - 文件：internal/processors/parser.go
  - 负责模块：内容处理
  - 预计时间：4小时
  - 完成时间：2025-11-05

#### 2.3 JSON生成器
- [x] **实现草稿JSON生成器**
  - 任务：创建生成标准提醒JSON的功能
  - 文件：internal/processors/json_generator.go
  - 负责模块：内容处理
  - 预计时间：2小时
  - 完成时间：2025-11-05

### 阶段三：CLI集成和测试

#### 3.1 CLI命令扩展
- [ ] **添加clip命令定义**
  - 任务：在 main.go 中添加新的 clip 命令处理逻辑
  - 文件：main.go
  - 负责模块：CLI接口
  - 预计时间：2小时

- [ ] **实现剪贴板处理流程**
  - 任务：集成所有模块，实现完整的剪贴板到JSON生成流程
  - 文件：main.go 或相关处理文件
  - 负责模块：CLI集成
  - 预计时间：3小时

#### 3.2 错误处理和日志
- [ ] **集成错误处理机制**
  - 任务：为新功能添加完善的错误处理
  - 文件：各新增模块文件
  - 负责模块：质量保证
  - 预计时间：2小时

- [ ] **添加日志记录功能**
  - 任务：为剪贴板和Dify处理过程添加详细日志
  - 文件：各新增模块文件
  - 负责模块：调试支持
  - 预计时间：1小时

#### 3.3 测试开发
- [ ] **编写单元测试**
  - 任务：为新增模块编写单元测试
  - 文件：*_test.go 文件
  - 负责模块：测试
  - 预计时间：4小时

- [ ] **进行端到端测试**
  - 任务：完整测试从截图到JSON生成的整个流程
  - 文件：测试用例文档
  - 负责模块：集成测试
  - 预计时间：2小时

### 阶段四：文档和优化

#### 4.1 文档更新
- [ ] **更新README.md**
  - 任务：添加新功能的使用说明和示例
  - 文件：README.md
  - 负责模块：文档
  - 预计时间：1小时

- [ ] **创建Dify配置指南**
  - 任务：编写详细的Dify API配置和使用指南
  - 文件：docs/DIFY_SETUP.md (或新文件)
  - 负责模块：文档
  - 预计时间：2小时

#### 4.2 优化和完善
- [ ] **性能优化**
  - 任务：优化图片处理和API调用性能
  - 文件：相关模块文件
  - 负责模块：性能优化
  - 预计时间：2小时

- [ ] **错误处理完善**
  - 任务：补充边界情况的错误处理
  - 文件：相关模块文件
  - 负责模块：质量保证
  - 预计时间：2小时

## 项目里程碑

### 里程碑1：基础架构完成 (阶段一完成)
- **目标**：完成所有基础模块和配置的搭建
- **验收标准**：项目可以编译，配置文件支持Dify配置，剪贴板和Dify客户端基础功能可用

### 里程碑2：核心功能完成 (阶段二完成)
- **目标**：完成从截图到JSON生成的完整功能
- **验收标准**：能够处理剪贴板内容，调用Dify API，生成标准提醒JSON文件

### 里程碑3：集成测试完成 (阶段三完成)
- **目标**：完成CLI集成和全面测试
- **验收标准**：通过clip命令可以完整处理截图并生成JSON文件

### 里程碑4：项目发布就绪 (阶段四完成)
- **目标**：完成文档和优化，项目可发布使用
- **验收标准**：文档完整，功能稳定，用户体验良好

## 预估时间统计

- **阶段一**：约 10.5 小时
- **阶段二**：约 14 小时
- **阶段三**：约 14 小时
- **阶段四**：约 7 小时

**总计**：约 45.5 小时

## 注意事项

1. **依赖库兼容性**：确保新增的Go库与现有依赖兼容
2. **跨平台支持**：剪贴板功能需要考虑Windows/Linux/macOS的差异
3. **API安全性**：Dify API密钥需要安全存储和传输
4. **错误恢复**：网络调用失败时需要有重试和降级机制
5. **性能考虑**：图片处理可能比较耗时，需要考虑异步处理

## 完成状态记录

- ✅ 已完成
- 🚧 进行中
- ❌ 未开始
- ⏸️ 暂停
- ❓ 需要讨论

---

*最后更新时间：2025-11-05*
*文档版本：v1.0*